{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.1-experimental",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.36.1.42791",
      "templateHash": "6045926537381406652"
    }
  },
  "parameters": {
    "appRoleId": {
      "type": "string",
      "nullable": true,
      "metadata": {
        "description": "ID of the application role to add to the resource app. Must be a GUID."
      }
    },
    "certKey": {
      "type": "securestring",
      "nullable": true,
      "metadata": {
        "description": "Value of the key credential."
      }
    }
  },
  "imports": {
    "microsoftGraphV1": {
      "provider": "MicrosoftGraph",
      "version": "1.0.0"
    }
  },
  "resources": {
    "resourceApp": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/applications@v1.0",
      "properties": {
        "uniqueName": "ExampleResourceApp",
        "displayName": "Example Resource Application",
        "appRoles": "[if(not(empty(parameters('appRoleId'))), createArray(createObject('id', parameters('appRoleId'), 'allowedMemberTypes', createArray('User', 'Application'), 'description', 'Read access to resource app data', 'displayName', 'ResourceAppData.Read.All', 'value', 'ResourceAppData.Read.All', 'isEnabled', true())), createArray())]"
      }
    },
    "resourceSp": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/servicePrincipals@v1.0",
      "properties": {
        "appId": "[reference('resourceApp').appId]"
      },
      "dependsOn": [
        "resourceApp"
      ]
    },
    "clientApp": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/applications@v1.0",
      "properties": {
        "uniqueName": "ExampleClientApp",
        "displayName": "Example Client Application",
        "keyCredentials": "[if(not(empty(parameters('certKey'))), createArray(createObject('displayName', 'Example Client App Key Credential', 'usage', 'Verify', 'type', 'AsymmetricX509Cert', 'key', parameters('certKey'))), createArray())]"
      }
    },
    "clientSp": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/servicePrincipals@v1.0",
      "properties": {
        "appId": "[reference('clientApp').appId]"
      },
      "dependsOn": [
        "clientApp"
      ]
    }
  }
}